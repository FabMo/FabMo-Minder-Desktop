<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FabMo Devices List</title>
    <link rel="stylesheet" href="css/pure.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/spinner.css" />
    <link rel="stylesheet" href="css/circle.css" />
    <script src="js/detection_service/server.js"></script>
  </head>


  <!-- Body of the page -->

  <body>
    <nav>
      <h1> FabMo Devices</h1>
      <a class="settings_button pure-button easy-modal-open" href="#settings_modal"><img src="./images/settings.png"></a>
    </nav>

    <div class="fabmo_devices_list">
			<div class="spinner">
			  <div class="double-bounce1"></div>
			  <div class="double-bounce2"></div>
			</div>
            <!--
            <div class="pure-g">
                <div class="pure-u-1-12"></div>
                <div class="panel pure-u-5-6"> 
                    <div class="wifi"><img src="images/wifi110.png"></div> 
                    <h3 class="toolName">tool.hostname</h3>
                    <div class="statusColor"></div>
                    <p class="statusTitle">tool.old_state</p> 
                    <div class="job">
                        <span class="job_label">Job : </span>
                        <span class="job_title">job.gc</span>
                        <div class="job_progress c100 p12 very_small">
                            <span>12%</span>
                            <div class="slice">
                                <div class="bar"></div>
                                <div class="fill"></div>
                            </div>
                        </div>
                    </div> 
                    <p class="ipAddress">ip</p> 
                    <a class="goHere" href="http://ip:port"><img src="images/newwindow.png"></a> 
                </div>
            </div>
            -->
    </div>

    <div class="easy-modal settings_modal" id="settings_modal">
        <div class="easy-modal-inner">
         <a class="close settings_modal_close pure-button">x</a>
         <div class="settings_modal_header">
             <h2>Settings</h2>
             <hr>
         </div>
         <div class="tray_settings">
        <form class="pure-form pure-form-stacked">
            <fieldset>
                <legend>Tray icon</legend>
                    <label for="min_tray_action" class="pure-checkbox">
                        <input class="settings_input" id="min_tray_action" type="checkbox" value="">
                        Continue to run the Tool Minder in the tray when minimize button is pressed.
                    </label>
                    <label for="close_tray_action" class="pure-checkbox">
                        <input class="settings_input" id="close_tray_action" type="checkbox" value="">
                        Continue to run the Tool Minder in the tray when exit button is pressed.
                    </label>
            </fieldset>
            <a class="pure-button settings_save_button pure-button-disabled">Save</a>
        </form>
        </div>
    </div>

    <script src="js/libs/jquery.js"></script>
    <script type="text/javascript" src="js/libs/jquery.easyModal.js"></script>
    <script src="js/libs/FabMo_Detection_service_API.js"></script>
    <script src="js/libs/fabmo.js"></script>  

       

    <script>
    opener = require('opener');
    nconf = require('nconf');
    $(document).ready(function() {
    	var gui = require('nw.gui');
    	var win = gui.Window.get();
    	var tray;
    	var menu = new gui.Menu();
    	var exit_button = new gui.MenuItem({
    		type: 'normal',
    		label: 'exit'
    	});
    	menu.append(exit_button);

    	// Get the minimize event

    	win.on('close', function() {
    		if(nconf.get('tray:reduce_on_close')){
                // Hide window
        		this.hide();

        		// Show tray
        		tray = new gui.Tray({
        			title: 'FabMo Tool Minder',
        			tooltip: 'The FabMo Tool Minder service is still running. click to reopen',
        			icon: './images/fabmo.png'
        		});
        		tray.menu = menu;
        		// Show window and remove tray when clicked
        		tray.on('click', function() {
        			win.show();
        			this.remove();
        			tray = null;
        		});
            }else{
                win.close(true);
            }
    	});

    	win.on('minimize', function() {
    		if(nconf.get('tray:reduce_on_minimize')){
                // Hide window
        		this.hide();

        		// Show tray
        		tray = new gui.Tray({
        			title: 'FabMo Tool Minder',
        			tooltip: 'The FabMo Tool Minder service is still running. click to reopen',
        			icon: './images/fabmo.png'
        		});
        		tray.menu = menu;
        		// Show window and remove tray when clicked
        		tray.on('click', function() {
        			win.show();
        			this.remove();
        			tray = null;
        		});
            }else{
               // do noting act like the normal behavior
            }
    	});

    	exit_button.on('click', function() {
    		win.close(true);
    	});



        $('.settings_modal').easyModal({"overlayClose":false});
        $('.easy-modal-open').click(function(e) {
            var target = $(this).attr('href');
            $(target).trigger('openModal');
            e.preventDefault();
        });

        $('.easy-modal-close').click(function(e) {
            $('.easy-modal').trigger('closeModal');
        });

        $(".easy-modal").on('openModal',function(e){
            $(".settings_save_button").removeClass("error_button done_button").addClass("pure-button-disabled");
            $(".settings_save_button").text("Save");
            //load settings config
            nconf.use('file', { file: gui.App.dataPath+'/settings.json' });

            $("#min_tray_action").prop("checked",nconf.get('tray:reduce_on_minimize'));
            $("#close_tray_action").prop("checked",nconf.get('tray:reduce_on_close'));
        });


        $(".settings_save_button").click(function(e){
            nconf.set('tray:reduce_on_minimize', $("#min_tray_action").prop("checked"));
            nconf.set('tray:reduce_on_close', $("#close_tray_action").prop("checked"));

            $(".settings_save_button").addClass("pure-button-disabled");
            // Save the configuration object to disk
            nconf.save(function (err) {
                if(err){
                    alert("Error saving the configuration : "+err);
                    $(".settings_save_button").addClass("error_button");
                    $(".settings_save_button").text("Error");
                }else{
                    $(".settings_save_button").addClass("done_button");
                    $(".settings_save_button").text("Done");
                }    
            });
        });

        $(".settings_input").click(function(e){
            // enable Save button only when an input changed
            $(".settings_save_button").removeClass("pure-button-disabled error_button done_button");
            $(".settings_save_button").text("Save");
        });



    	var tools_list = [];

    	function display_tools(tools) {
    		$('.fabmo_devices_list').empty();
    		if(Object.keys(tools).length<=0) // tools.length doesn't work as we doesn't decrease the size of the array each time we delete a tool
    		{
    			spinner_html='<div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>'+
    			"<div class='apologies'><p>Sorry. Despite my best efforts, I wasn't able to locate any tools...</p><p>I will persist though !</p></div> ";
    			$('.fabmo_devices_list').append(spinner_html);

    		}
    		else{
	    		tools.forEach(function(tool, index, array) {
	    			toolInfo = {};


	    			ChooseBestWayToConnect(tool, function(ip, port) {
	    				toolInfo.ip = ip;
	    				toolInfo.port = port;

	    			});
	    			var ip = toolInfo.ip;
	    			var port = toolInfo.port;



	    			tool_html = '<div class="pure-g '+tool.hostname+'"><div class="pure-u-1-12"></div><div class="panel pure-u-5-6">' +
	    				'<div class="wifi"><img src="images/wifi110.png"></div>' +
	    				'<h3 class="toolName">' + tool.hostname + '</h3>' + '<div class="statusColor '+(tool.old_state||'')+'"></div><p class="statusTitle">'+(tool.old_state||'')+'</p>' +
	    				'<div class="job"><span class="job_label">'+((tool.old_job)?'Job : ':'')+'</span><span class="job_title">'+(tool.old_job||'')+'</span></div>' +
                        '<div class="'+((tool.old_job)?'':'hidden')+' job_progress c100 p'+(tool.old_percentage||0)+' very_small"><span>'+(tool.old_percentage||0)+' %</span><div class="slice"><div class="bar"></div><div class="fill"></div></div></div>'+
	    				'<p class="ipAddress">' + ip + '</p>' +
	    				'<a class="goHere" href="http://' + ip + ':' + port + '"><img src="images/newwindow.png"></a>' +
	    				'</div></div>';
	    			$('.fabmo_devices_list').append(tool_html);


	    			$.ajax({
	    				url: 'http://' + ip + ':' + port + '/status',
	    				type: "GET"
	    			}).done(function(data) {
	    				var state = data.data.status.state;
	    				var job = (data.data.status.job)?data.data.status.job.name:undefined;
	    				$('.'+tool.hostname+' .statusColor').removeClass('running idle manual paused stopped').addClass(state);
	    				$('.'+tool.hostname+' .statusTitle').text(state);

	    				if(job){
		    				$('.'+tool.hostname+' .job_label').text('Job : '); 
		    				$('.'+tool.hostname+' .job_title').text(job);
                            percentage=Math.round((data.data.status.line/data.data.status.nb_lines)*100);
                            $('.'+tool.hostname+' .job_progress').removeClass().addClass("job_progress c100 p"+percentage+" very_small");
                            $('.'+tool.hostname+' .job_progress span').text(percentage+' %');
	    				}else{
		    				$('.'+tool.hostname+' .job_label').text(''); 
		    				$('.'+tool.hostname+' .job_title').text('');
                            $('.'+tool.hostname+' .job_progress').removeClass("job_progress").addClass("hidden");
                            percentage="";
	    				}
	  				    tool.old_percentage=percentage;
	    				tool.old_state=state;
	    				tool.old_job=job;
	    			}).fail(function() {
	    				err = "Link API not responding !";
	    				console.log(err);
	    			});

	    		});

	    		$('.goHere').on("click", function(e) {
	    			e.preventDefault();
	    			opener(this.href);
	    			return false;
	    		});
	    	}
    	}


    	setInterval(function() {
    		DetectToolsOnTheNetworks(
    			function(err, data) {
    				if (err) {
    					console.error(err);
    				} else {
    					detected_tool_registered_index = [];
    					for (var detected_tool in data) {
    						tool_already_registered = false;
    						for (var registered_tool in tools_list) {
    							if (data[detected_tool].hostname === tools_list[registered_tool].hostname) { // if tool is still present.
    								tool_already_registered = true;
    								detected_tool_registered_index.push(registered_tool);
    							}
    						}
    						if (!tool_already_registered) { // new tool
    							detected_tool_registered_index.push(tools_list.push(data[detected_tool]) - 1); // add the tool to the list and its index to the dedicated array
    						}
    					}
    					for (var registered_tool_index in tools_list) {
    						if (detected_tool_registered_index.indexOf(registered_tool_index) !== -1) { // if the registered tool was detected
    							tools_list[registered_tool_index].unregister_counter = 0; // reset the unregister counter
    						} else {
    							tools_list[registered_tool_index].unregister_counter++; //if not increment the unregister counter
    						}
    						if (tools_list[registered_tool_index].unregister_counter > 4) { // delete the tool from the list after 5 times without detection.
    							delete tools_list[registered_tool_index];
    						}
    					}
    					display_tools(tools_list);
    				}
    			});
    	}, 2000);

    });

    </script>
  </body>
</html>