<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FabMo Devices List</title>
    <link rel="stylesheet" href="css/pure.min.css" />
    <script src="js/detection_service/server.js"></script>
    <style>
    	.panel{
    		background-color: #f3f3f3;
    	}
    	h1{
    		margin-left: 1em;
    	}
    	h3{
    		margin-left: 2em;
    	}
    	p{
    		margin-left: 2em;
    	}
    	.pure-button{
    		display: block;
    	}
    </style>
  </head>


  <!-- Body of the page -->

  <body>
    <nav class="tab-bar">
      <h1> FabMo Devices List </h1>
    </nav>

    <div class="fabmo_devices_list">
    </div>


    <script src="js/libs/jquery.js"></script>
    <script src="js/libs/FabMo_Detection_service_API.js"></script>  
    <script>
    var opener=require('opener');
    $(document).ready(function(){
      var gui = require('nw.gui');
      var win = gui.Window.get();
      var tray;
			var menu = new gui.Menu();
			var exit_button = new gui.MenuItem({ type: 'normal', label: 'exit' });
			menu.append(exit_button);
  	  // Get the minimize event


  	  win.on('close', function() {
  	  	 // Hide window
	      this.hide();

	      // Show tray
	      tray = new gui.Tray({ title: 'FabMo Tool Minder',tooltip:'The FabMo Tool Minder service is still running. click to reopen', icon: 'fabmo.png' });
				tray.menu = menu;
	      // Show window and remove tray when clicked
	      tray.on('click', function() {
	        win.show();
	        this.remove();
	        tray = null;
	      });
  	  });

	    win.on('minimize', function() {
	      // Hide window
	      this.hide();

	      // Show tray
	      tray = new gui.Tray({ title: 'FabMo Tool Minder',tooltip:'The FabMo Tool Minder service is still running. click to reopen', icon: 'fabmo.png' });
				tray.menu = menu;
	      // Show window and remove tray when clicked
	      tray.on('click', function() {
	        win.show();
	        this.remove();
	        tray = null;
	      });
	    });

			exit_button.on('click',function(){
				win.close(true);
			});





      setInterval(function(){
        DetectToolsOnTheNetworks(
        function(err,data){
          if(err)console.error(err);
          if(data.length!==0){ // sometime the service returns an empty array
            $('.fabmo_devices_list').empty();
          }
          data.forEach(function(tool,index,array){
            ChooseBestWayToConnect(tool,function(ip,port){
            tool_html='<div class="pure-g"><div class="pure-u-1-12"></div><div class="panel pure-u-5-6">'+
                      '<h3>'+tool.hostname+'</h3>'+
                      '<p>'+ip+'</p>'+
                      '<a class="pure-button" href="http://'+ip+':'+port+'">Go to that device</a>'+
                      '</div></div>';
            $('.fabmo_devices_list').append(tool_html);
            });
          });

					$('.pure-button').on("click",function(e){
						e.preventDefault();
						opener(this.href);	
						return false;
					});

      });
      },2000);
    });

    </script>
  </body>
</html>