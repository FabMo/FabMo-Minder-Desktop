<!DOCTYPE HTML5>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FabMo Devices List</title>
    <link rel="stylesheet" href="css/pure.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/spinner.css" />
    <link rel="stylesheet" href="css/circle.css" />
    <script src="js/detection_service/server.js"></script>
</head>


<!-- Body of the page -->

<body>
    <nav>
        <h1> FabMo Devices</h1>
        <a class="settings_button pure-button easy-modal-open" href="#settings_modal"><img src="./images/settings.png"></a>
    </nav>

    <div class="fabmo_devices_list">

        <div class="spinner">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>
        <!--
        <div class="pure-g ToolMinder-testing">
            <div class="pure-u-1-12"></div>
            <div class="panel pure-u-5-6">
                <div class="wifi"><img src="images/wifi110.png"></div>
                <h3 class="toolName">ToolMinder-testing</h3>
                <div class="statusColor idle"></div>
                <p class="statusTitle">idle</p>
                <div class="job">
                    <span class="job_label"/></span>
                    <span class="job_title"></span>
                    <div class="hidden c100 p0 very_small">
                        <span>0 %</span>
                        <div class="slice">
                            <div class="bar"></div>
                            <div class="fill"></div>
                        </div>
                    </div>
                </div>
                <p class="ipAddress">192.168.x.x</p>
                <a class="goHere" href="http://192.168.x.x:80"><img src="images/newwindow.png"></a>
                <a class="pure-button minimize_button">&and;</a>
            </div>
        </div>
        -->
    </div>

    <div class="easy-modal settings_modal" id="settings_modal">
        <div class="easy-modal-inner">
            <a class="close settings_modal_close pure-button">x</a>
            <div class="settings_modal_header">
                <h2>Settings</h2>
                <hr>
            </div>
            <div class="tray_settings">
                <form class="pure-form pure-form-stacked">
                    <fieldset>
                        <legend>Tray icon</legend>
                        <label for="min_tray_action" class="pure-checkbox">
                            <input class="settings_input" id="min_tray_action" type="checkbox" value="">
                            Continue to run the Minder in the tray when minimize button is pressed.
                        </label>
                        <label for="close_tray_action" class="pure-checkbox">
                            <input class="settings_input" id="close_tray_action" type="checkbox" value="">
                            Continue to run the Minder in the tray when exit button is pressed.
                        </label>
                    </fieldset>
                    <fieldset>
                        <legend>Auto Launch</legend>
                        <label for="startup_action" class="pure-checkbox">
                            <input class="settings_input" id="startup_action" type="checkbox" value="">
                            Launch the Minder at system startup.
                        </label>
                    </fieldset>
                    <a class="pure-button settings_save_button pure-button-disabled">Save</a>
                </form>
            </div>
        </div>
    </div>

    <script src="js/libs/jquery.js"></script>
    <script type="text/javascript" src="js/libs/jquery.easyModal.js"></script>
    <script src="js/libs/FabMo_Detection_service_API.js"></script>
    <script src="js/libs/fabmo.js"></script>


    <script type="text/javascript">
        opener = require('opener');
        nconf = require('nconf');
        parse_args = require('minimist');
        gui = require('nw.gui');
        process = require('process');

        var AutoLaunch = require('auto-launch');
        var appLauncher = new AutoLaunch({name: 'FabMo Minder'});
        global.cmd_line_args = {};
        nconf.use('file', { file: gui.App.dataPath+'/settings.json' });

        var tray;
        var trayMenu;

        gui.App.on('open', function(cmdline) {
          var args = cmdline.split(" ").slice(1);
          if (args[0]==="."){ // avoid bug while running from source.
            args.shift();
          }
            if(args[0]===undefined){
                gui.Window.get().focus();
                return;
            }
          global.cmd_line_args = parse_args(args);
          window.location.reload();
          window.location = "./launch_file.html";
        });

        if(gui.App.argv){
            global.cmd_line_args = parse_args(gui.App.argv);
            if( !global.fileTransmittedViaArgv && gui.App.argv.length >= 1 && gui.App.argv[0]){
                global.fileTransmittedViaArgv = true;
                window.location.reload();
                window.location = "./launch_file.html";
            }

        }

        function hideTray() {
            if(tray) {
                tray.remove();
                tray = null;
            }
        }

        function showTray(win) {
            if(tray) { return; }

            switch(process.platform) {
                case 'darwin':
                    var trayTitle = '';
                    var trayTooltip = 'FabMo Minder';
                    var trayIcon = './images/fabmo-icon-18x18.png';
                    break;
                default:
                    var trayTitle = 'FabMo Minder';
                    var trayTooltip = 'The FabMo Minder service is still running. click to reopen';
                    var trayIcon = './images/fabmo-icon.png';
                    break;
            }

            // Show tray
            tray = new gui.Tray({
                title: trayTitle,
                tooltip: trayTooltip,
                icon: trayIcon
            });

            tray.menu = trayMenu;
            // Show window and remove tray when clicked
            tray.on('click', function() {
                win.show();
                this.remove();
                tray = null;
            });
        }

        $(document).ready(function() {
            var win = gui.Window.get();
            trayMenu = new gui.Menu();

            // Show Minder
            switch(process.platform) {
                case 'darwin':
                    var menuItemShow = new gui.MenuItem({
                        type: 'normal',
                        label: 'Show Minder'
                    });
                    menuItemShow.on('click', function() {
                        win.restore();
                        win.focus();
                    });
                    trayMenu.append(menuItemShow);
                    break;
            }

            // Exit
            var menuItemExit = new gui.MenuItem({
                type: 'normal',
                label: 'Exit'
            });
            menuItemExit.on('click', function() {
                win.close(true);
            });
            trayMenu.append(menuItemExit);

            // Get the close event
            win.on('close', function() {
                if(nconf.get('tray:reduce_on_close')){
                    win.hide();
                    showTray(this);
                }else{
                    win.close(true);
                }
            });

            // Get the minimize event
            win.on('minimize', function() {

                if(nconf.get('tray:reduce_on_minimize')){
                    // Hide window
                    win.hide();
                    showTray(this);
                } else{
                   // do noting act like the normal behavior
                }
            });

            win.on('focus', function() {
                hideTray();
            });

            $('.settings_modal').easyModal({"overlayClose":false});
            $('.easy-modal-open').click(function(e) {
                var target = $(this).attr('href');
                $(target).trigger('openModal');
                e.preventDefault();
            });

            $('.easy-modal-close').click(function(e) {
                $('.easy-modal').trigger('closeModal');
            });

            $(".easy-modal").on('openModal',function(e){
                $(".settings_save_button").removeClass("error_button done_button").addClass("pure-button-disabled");
                $(".settings_save_button").text("Save");
                //load settings config

                $("#min_tray_action").prop("checked",nconf.get('tray:reduce_on_minimize'));
                $("#close_tray_action").prop("checked",nconf.get('tray:reduce_on_close'));
                $("#startup_action").prop("checked",nconf.get('startup:launch_on_startup'));
              });


            $(".settings_save_button").click(function(e){
                if($(this).hasClass('pure-button-disabled')) {
                    return;
                }

                nconf.set('tray:reduce_on_minimize', $("#min_tray_action").prop("checked"));
                nconf.set('tray:reduce_on_close', $("#close_tray_action").prop("checked"));
                nconf.set('startup:launch_on_startup', $("#startup_action").prop("checked"));

                if(nconf.get('startup:launch_on_startup')){
                    appLauncher.enable(function(err){
                        if(err){
                            console.error(err);
                            //alert("Error enabling the auto-launch on startup: "+err);
                        }
                    });
                }else{

                    appLauncher.disable(function(err){
                        if(err){
                            console.error(err);
                            //alert("Error disabling the auto-launch on startup: "+err);
                        }
                    });
                }

                $(".settings_save_button").addClass("pure-button-disabled");
                // Save the configuration object to disk
                nconf.save(function (err) {
                    if(err){
                        alert("Error saving the configuration : "+err);
                        $(".settings_save_button").addClass("error_button");
                        $(".settings_save_button").text("Error");
                    }else{
                        $(".settings_save_button").addClass("done_button");
                        $(".settings_save_button").text("Done");
                    }
                    console.log("clsing model")
                    $('.easy-modal').trigger('closeModal');
                });
              });
          });

    	$(".settings_input").click(function(e){
            // enable Save button only when an input changed
            $(".settings_save_button").removeClass("pure-button-disabled error_button done_button");
            $(".settings_save_button").text("Save");
          });

		  last_tools=[];

    	function displayTools(tools) {
    		$('.fabmo_devices_list').empty();
    		if(Object.keys(tools).length<=0) // tools.length doesn't work as we doesn't decrease the size of the array each time we delete a tool
    		{
    			spinner_html=
					'<div class="spinner">'+
						'<div class="double-bounce1"></div>'+
						'<div class="double-bounce2"></div>'+
					'</div>'+
	    			"<div class='apologies'>"+
						"<p>Sorry. Despite my best efforts, I wasn't able to locate any tools...</p>"+
						"<p>I will persist though !</p>"+
					"</div> ";

    			$('.fabmo_devices_list').append(spinner_html);

    		}
    		else{
    			tools.forEach(function(tool, index, array) {
    				toolInfo = {};


    				ChooseBestWayToConnect(tool, function(ip, port) {
    					toolInfo.ip = ip;
    					toolInfo.port = port;

    				});
    				var ip = toolInfo.ip;
    				var port = toolInfo.port;


						var old_state,old_job,old_percentage,isCrashed;
						if(last_tools && last_tools[tool.hostname]){
							old_percentage =last_tools[tool.hostname].percentage;
							old_state =last_tools[tool.hostname].state;
							old_job =last_tools[tool.hostname].job;
                            isCrashed = last_tools[tool.hostname].isCrashed;
						}


						tool_html =
	            			'<div class="pure-g '+tool.hostname+'">'+
				            	'<div class="pure-u-1-12"></div>'+
				              	'<div class="panel pure-u-5-6">' +
			        				'<div class="panelHeader">'+
										'<div class="wifi"><img src="images/wifi110.png"></div>' +
				        				'<div class=" toolName-scroll-box scroll-box"><div class="toolName scroll-text">' + tool.hostname + '</div></div>'+
										'<div class="statusContainer">'+
		                					'<div class="statusColor '+(old_state||'')+'"></div>'+
		                					'<p class="statusTitle">'+(old_state||'')+'</p>' +
										'</div>'+
									'</div>'+
									'<p class="ipAddress">' + ip + '</p>' +
									'<a class="goHere '+(isCrashed?"goUpdater":"")+'" href="http://' + ip + ':' + ((old_state==='crashed')?port+1:port) + '"><img src="images/newwindow.png"></a>' +
			        				'<div class="job">'+
										'<div class="'+((old_job)?'':'hidden')+' job_progress c100 p'+(old_percentage||0)+' very_small">'+
											'<span>'+(old_percentage||0)+' %</span>'+
											'<div class="slice"><div class="bar"></div><div class="fill"></div></div>'+
										'</div>'+
	                  					'<span class="job_label">'+((old_job)?'Job : ':'')+'</span>'+
	                  					'<div class="jobName-scroll-box scroll-box"><div class="scroll-text"><span class="job_title">'+(old_job||'')+'</span></div></div>'+
									'</div>' +
			    				'</div>'+
	            			'</div>';
    				$('.fabmo_devices_list').append(tool_html);


    				$.ajax({
    					url: 'http://' + ip + ':' + port + '/status',
    					type: "GET"
    				}).done(function(data) {
    					var state = data.data.status.state;
    					var job = (data.data.status.job)?data.data.status.job.name:undefined;

							$('.'+tool.hostname+' .statusColor').removeClass('running idle manual paused stopped crashed').addClass(state);
							$('.'+tool.hostname+' .statusTitle').text(state);
    					if(job){
    						$('.'+tool.hostname+' .job_label').text('Job : ');
    						$('.'+tool.hostname+' .job_title').text(job);
    						percentage=Math.round((data.data.status.line/data.data.status.nb_lines)*100);
    						$('.'+tool.hostname+' .job_progress').removeClass().addClass("job_progress c100 p"+percentage+" very_small");
    						$('.'+tool.hostname+' .job_progress span').text(percentage+' %');
    					}else{
    						$('.'+tool.hostname+' .job_label').text('');
    						$('.'+tool.hostname+' .job_title').text('');
    						$('.'+tool.hostname+' .job_progress').removeClass("job_progress").addClass("hidden");
    						percentage="";
    					}
						last_tools[tool.hostname]={};
    					last_tools[tool.hostname].percentage=percentage;
    					last_tools[tool.hostname].state=state;
    					last_tools[tool.hostname].job=job;
                        last_tools[tool.hostname].isCrashed=false;
    				}).fail(function() {
    					// Engine is not responding
                        var state = 'crashed';
                        $('.'+tool.hostname+' .statusColor').removeClass('running idle manual paused stopped crashed').addClass(state);
                        $('.'+tool.hostname+' .statusTitle').text(state);
                        $('.'+tool.hostname+' .job_label').text('');
                        $('.'+tool.hostname+' .job_title').text('');
                        $('.'+tool.hostname+' .job_progress').removeClass("job_progress").addClass("hidden");
                        percentage="";
                        $('.'+tool.hostname+' .goHere').attr('href','http://' + ip + ':' + (port+1));

                        last_tools[tool.hostname]={};
                        last_tools[tool.hostname].percentage=percentage;
                        last_tools[tool.hostname].state=state;
                        last_tools[tool.hostname].job=undefined;
                        last_tools[tool.hostname].isCrashed = true;
    				});

    			});

    			$('.goHere').on("click", function(e) {
    				e.preventDefault();
    				opener(this.href);
    				return false;
    			});

				$('.scroll-box').mouseenter(function () {
					$(this).active =true;
					$(this).stop();
					var boxWidth = $(this).width();
					var textWidth = $('.scroll-text', $(this)).width();
					if (textWidth > boxWidth) {
						var animSpeed = textWidth * 5;
						$(this).animate({
							scrollLeft: (textWidth - boxWidth)
						}, animSpeed, function () {
							$(this).animate({
								scrollLeft: 0
							}, animSpeed, function () {
								$(this).trigger('mouseenter');
							});
						});
					}
				}).mouseleave(function () {
					var animSpeed = $(this).scrollLeft() * 5;
					$(this).stop().animate({
						scrollLeft: 0
					}, animSpeed);
				});

    		}
    	}


    	setInterval(function() {
    		DetectToolsOnTheNetworks(
    			function(err, data) {
    				if (err) {
    					console.error(err);
    				} else {
    					displayTools(data);
    				}
    			});
    	}, 2000);


	</script>
</body>
</html>
