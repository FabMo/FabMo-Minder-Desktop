<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FabMo Devices List</title>
    <link rel="stylesheet" href="css/pure.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/spinner.css" />
    <script src="js/detection_service/server.js"></script>
  </head>


  <!-- Body of the page -->

  <body>
    <nav>
      <h1> FabMo Devices</h1>
    </nav>

    <div class="fabmo_devices_list">
			<div class="spinner">
			  <div class="double-bounce1"></div>
			  <div class="double-bounce2"></div>
			</div>
    </div>


    <script src="js/libs/jquery.js"></script>
    <script src="js/libs/FabMo_Detection_service_API.js"></script>
    <script src="js/libs/fabmo.js"></script>  

       

    <script>
var opener = require('opener');
    $(document).ready(function() {
    	var gui = require('nw.gui');
    	var win = gui.Window.get();
    	var tray;
    	var menu = new gui.Menu();
    	var exit_button = new gui.MenuItem({
    		type: 'normal',
    		label: 'exit'
    	});
    	menu.append(exit_button);
    	// Get the minimize event

    	win.on('close', function() {
    		// Hide window
    		this.hide();

    		// Show tray
    		tray = new gui.Tray({
    			title: 'FabMo Tool Minder',
    			tooltip: 'The FabMo Tool Minder service is still running. click to reopen',
    			icon: 'fabmo.png'
    		});
    		tray.menu = menu;
    		// Show window and remove tray when clicked
    		tray.on('click', function() {
    			win.show();
    			this.remove();
    			tray = null;
    		});
    	});

    	win.on('minimize', function() {
    		// Hide window
    		this.hide();

    		// Show tray
    		tray = new gui.Tray({
    			title: 'FabMo Tool Minder',
    			tooltip: 'The FabMo Tool Minder service is still running. click to reopen',
    			icon: 'fabmo.png'
    		});
    		tray.menu = menu;
    		// Show window and remove tray when clicked
    		tray.on('click', function() {
    			win.show();
    			this.remove();
    			tray = null;
    		});
    	});

    	exit_button.on('click', function() {
    		win.close(true);
    	});

    	var tools_list = [];

    	function display_tools(tools) {
    		$('.fabmo_devices_list').empty();
    		if(Object.keys(tools).length<=0) // tools.length doesn't work as we doesn't decrease the size of the array each time we delete a tool
    		{
    			spinner_html='<div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>'+
    			"<div class='apologies'><p>Sorry. Despite my best efforts, I wasn't able to locate any tools...</p><p>I will persist though !</p></div> ";
    			$('.fabmo_devices_list').append(spinner_html);

    		}
    		else{
	    		tools.forEach(function(tool, index, array) {
	    			toolInfo = {};


	    			ChooseBestWayToConnect(tool, function(ip, port) {
	    				toolInfo.ip = ip;
	    				toolInfo.port = port;

	    			});
	    			var ip = toolInfo.ip;
	    			var port = toolInfo.port;



	    			tool_html = '<div class="pure-g '+tool.hostname+'"><div class="pure-u-1-12"></div><div class="panel pure-u-5-6">' +
	    				'<div class="wifi"><img src="images/wifi110.png"></div>' +
	    				'<h3 class="toolName">' + tool.hostname + '</h3>' + '<div class="statusColor '+(tool.old_state||'')+'"></div><p class="statusTitle">'+(tool.old_state||'')+'</p>' +
	    				'<div class="job"><span class="job_label">'+((tool.old_job)?'Job : ':'')+'</span><span class="job_title">'+(tool.old_job||'')+'</span></div>' +
	    				'<p class="ipAddress">' + ip + '</p>' +
	    				'<a class="goHere" href="http://' + ip + ':' + port + '"><img src="images/newwindow.png"></a>' +
	    				'</div></div>';
	    			$('.fabmo_devices_list').append(tool_html);


	    			$.ajax({
	    				url: 'http://' + ip + ':' + port + '/status',
	    				type: "GET"
	    			}).done(function(data) {
	    				var state = data.data.status.state;
	    				var job = (data.data.status.job)?data.data.status.job.name:undefined;
	    				$('.'+tool.hostname+' .statusColor').removeClass('running idle manual paused stopped').addClass(state);
	    				$('.'+tool.hostname+' .statusTitle').text(state);

	    				if(job){
		    				$('.'+tool.hostname+' .job_label').text('Job : '); 
		    				$('.'+tool.hostname+' .job_title').text(job);  
	    				}else{
		    				$('.'+tool.hostname+' .job_label').text(''); 
		    				$('.'+tool.hostname+' .job_title').text('');  
	    				}
	  				
	    				tool.old_state=state;
	    				tool.old_job=job;
	    			}).fail(function() {
	    				err = "Link API not responding !";
	    				console.log(err);
	    			});

	    		});

	    		$('.goHere').on("click", function(e) {
	    			e.preventDefault();
	    			opener(this.href);
	    			return false;
	    		});
	    	}
    	}


    	setInterval(function() {
    		DetectToolsOnTheNetworks(
    			function(err, data) {
    				if (err) {
    					console.error(err);
    				} else {
    					detected_tool_registered_index = [];
    					for (var detected_tool in data) {
    						tool_already_registered = false;
    						for (var registered_tool in tools_list) {
    							if (data[detected_tool].hostname === tools_list[registered_tool].hostname) { // if tool is still present.
    								tool_already_registered = true;
    								detected_tool_registered_index.push(registered_tool);
    							}
    						}
    						if (!tool_already_registered) { // new tool
    							detected_tool_registered_index.push(tools_list.push(data[detected_tool]) - 1); // add the tool to the list and its index to the dedicated array
    						}
    					}
    					for (var registered_tool_index in tools_list) {
    						if (detected_tool_registered_index.indexOf(registered_tool_index) !== -1) { // if the registered tool was detected
    							tools_list[registered_tool_index].unregister_counter = 0; // reset the unregister counter
    						} else {
    							tools_list[registered_tool_index].unregister_counter++; //if not increment the unregister counter
    						}
    						if (tools_list[registered_tool_index].unregister_counter > 4) { // delete the tool from the list after 5 times without detection.
    							delete tools_list[registered_tool_index];
    						}
    					}
    					display_tools(tools_list);
    				}
    			});
    	}, 2000);

    });

    </script>
  </body>
</html>